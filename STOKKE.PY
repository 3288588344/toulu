#æŠ“åŒ…www.stokkeshop.cnåŸŸåä¸‹çš„Authori-zationå€¼å¡«åˆ°ç¯å¢ƒå˜é‡STOKKEä¸­ï¼Œå¤šè´¦å·ç”¨&åˆ†å‰²
#å…¥å£:http://mx.qrurl.net/h5/wxa/link?sid=25726gMa4HG


import os
import re
import requests
from typing import List, Dict, Tuple

# ---------- é€šç”¨è¯·æ±‚å¤´ ----------
_BASE_HEADERS = {
    "Host": "www.stokkeshop.cn",
    "Connection": "keep-alive",
    "content-type": "application/json",
    "charset": "utf-8",
    "Referer": "https://servicewechat.com/wxe232c36aaca3dc1a/34/page-frame.html",
    "Accept-Encoding": "gzip, deflate, br"
}

# ---------- è·å–ç”¨æˆ·ä¿¡æ¯ ----------
def _get_user_info(token: str) -> Dict[str, str]:
  
    url = "https://www.stokkeshop.cn/api/front/user"
    headers = _BASE_HEADERS.copy()
    headers["Authori-zation"] = token
    try:
        resp = requests.get(url, headers=headers, timeout=10)
        resp.raise_for_status()
        data = resp.json()
        if data.get("code") != 200:
            return {}
        d = data["data"]
        raw_phone = d["phone"]
        masked = re.sub(r"(\d{3})\d{4}(\d{4})", r"\1****\2", raw_phone)
        return {"nick": d["nickname"], "phone": masked, "integral": str(d["integral"])}
    except Exception:
        return {}

# ---------- ç­¾åˆ° ----------
def week_sign_all() -> None:
    tokens = os.getenv("STOKKE", "").split("&")
    if not tokens or tokens == [""]:
        print("âš ï¸  ç¯å¢ƒå˜é‡ STOKKE ä¸ºç©ºï¼Œæœªé…ç½®ä»»ä½• è´¦å·ä¿¡æ¯ã€‚")
       
        return

    url = "https://www.stokkeshop.cn/api/front/integral-task/finishWeekSign"
    payload = {}

    for token in tokens:
        token = token.strip()
        if not token:
            continue

        user = _get_user_info(token)
        if not user:
            print("âŒ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè·³è¿‡å½“å‰è´¦å·ã€‚")
            print("=" * 45)
            continue

        headers = _BASE_HEADERS.copy()
        headers["Authori-zation"] = token
        try:
            resp = requests.post(url, json=payload, headers=headers, timeout=10)
            resp.raise_for_status()
            data = resp.json()
            ok = data.get("code") == 200
            print(
                f"{'âœ…' if ok else 'âŒ'} "
                f"{user['nick']}({user['phone']}) ç­¾åˆ°{'æˆåŠŸ' if ok else 'å¤±è´¥'}ï¼Œ"
                f"å½“å‰ç§¯åˆ† {user['integral']}"               
            )
            print("=" * 45)
        except Exception as e:
            print(
                f"â— ç½‘ç»œå¼‚å¸¸ï¼š{user['nick']}({user['phone']}) ç­¾åˆ°å¤±è´¥ï¼Œå½“å‰ç§¯åˆ† {user['integral']} "
                f"({e})"
            )

# -------------------- å…¬å‘Š --------------------
def get_proclamation():
    primary_url = "https://github.com/3288588344/toulu/raw/refs/heads/main/tl.txt"
    backup_url   = "https://tfapi.cn/TL/tl.json"

    for url in (primary_url, backup_url):
        try:
            r = requests.get(url, timeout=10)
            if r.status_code == 200:
                print("ğŸ“¢ å…¬å‘Šä¿¡æ¯")
                print("=" * 45)
                print(r.text)
                print("=" * 45 + "\n")
                return
        except Exception as e:
            continue
    print("âš ï¸ è·å–å…¬å‘Šå¤±è´¥ï¼Œè·³è¿‡å…¬å‘Šç›´æ¥æ‰§è¡Œç­¾åˆ°...\n")

# ---------- ç¤ºä¾‹ ----------
if __name__ == "__main__":
    get_proclamation()
    week_sign_all()
